<!doctype html>
<    <div style="padding: 8px;">
        <select id="language-selector" class="input" style="width: auto; margin-right: 12px;" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="ur">Roman Urdu</option>
        </select>
    </div>
    <div class="chatLayout">
    <div class="globalCol">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div><strong id="myName">Anonymous</strong></div>
        <div style="font-size:13px;color:#33ff33" id="global-chat-text">Global ephemeral chat</div>
      </div>ang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="pChat - Real-time chat application">
    <title>Chat — pChat</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="chat-styles.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <div id="loadingScreen" class="loadingScreen">
    <div class="loadingContent">
      <div class="loadingText">Connecting...</div>
      <div class="loadingSpinner"></div>
    </div>
  </div>
  <div class="chatLayout">
    <div class="globalCol">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div><strong id="myName">Anonymous</strong></div>
        <div style="font-size:13px;color:#33ff33">Global ephemeral chat</div>
      </div>
      <div class="chatBox" id="chatBox" role="log" aria-live="polite"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="msg" class="input" placeholder="Send to all, or use #username to send a private message (example: #jok3r hi)" />
        <button id="send" class="btn">Send</button>
      </div>
    </div>
    <div class="sideCol">
      <div class="pmHeader">Private Sidebar</div>
      <div class="pmList" id="pmList"></div>
      <div style="font-size:12px;color:#33ff33;margin-top:8px">Use <code>#username</code> at start of message to send private notes to that user only.</div>
    </div>
  </div>
<script src="/socket.io/socket.io.js"></script>
  <script>
  const translations = {
    en: {
        globalChat: "Global Chat Room",
        privateSidebar: "Private Messages",
        sendPlaceholder: "Send to all, or use #username to send a private message",
        privateNote: "Click on a user to open private chat",
        sendBtn: "Send",
        connecting: "Connecting...",
        connectionError: "Connection error. Retrying...",
        disconnected: "Disconnected. Reconnecting..."
    },
    ur: {
        globalChat: "Global Chat Room",
        privateSidebar: "Private Messages",
        sendPlaceholder: "Sab ko message bhejne ke liye type karen, ya private message ke liye #username istimal karen",
        privateNote: "Private chat kholne ke liye user par click karen",
        sendBtn: "Bhejein",
        connecting: "Connect ho raha hai...",
        connectionError: "Connection error. Dobara koshish kar rahe hain...",
        disconnected: "Disconnect ho gaya. Reconnect ho raha hai..."
    }
  };

  const socket = io();
  const loadingScreen = document.getElementById('loadingScreen');
  const chatBox = document.getElementById('chatBox');
  const pmList = document.getElementById('pmList');
  const nameEl = document.getElementById('myName');
  const msgInput = document.getElementById('msg');
  const sendBtn = document.getElementById('send');
  const name = localStorage.getItem('chatUsername');
  const color = '#00ff00';
  
  let activePrivateChats = new Map(); // Store active private chat users and their messages  // Redirect if no username
  if(!name) {
    window.location.href = '/join.html';
  }

  // Handle connection errors
  socket.on('connect_error', () => {
    loadingScreen.style.display = 'flex';
    loadingScreen.querySelector('.loadingText').textContent = 'Connection error. Retrying...';
  });

  // Handle successful connection
  socket.on('connect', () => {
    loadingScreen.style.display = 'none';
  });

  // Handle disconnection
  socket.on('disconnect', () => {
    loadingScreen.style.display = 'flex';
    loadingScreen.querySelector('.loadingText').textContent = 'Disconnected. Reconnecting...';
  });
  nameEl.textContent = name;
  socket.on('connect', () => {
    socket.emit('set username', { name: name, color: color });
  });
  function appendGlobal(payload){ const el=document.createElement('div'); el.className='msg'; const meta=document.createElement('div'); meta.className='meta'; meta.textContent = payload.user + ' · ' + payload.fakeIp; const body=document.createElement('div'); body.className='msgBody'; body.textContent = payload.text; el.appendChild(meta); el.appendChild(body); el.style.borderLeft='4px solid '+(payload.color||'#00ff00'); chatBox.appendChild(el); chatBox.scrollTop = chatBox.scrollHeight; }
  function appendPrivate(payload) {
    let username = payload.from;
    if (!activePrivateChats.has(username)) {
      activePrivateChats.set(username, []);
      const el = document.createElement('div');
      el.className = 'pmItem';
      el.setAttribute('data-username', username);
      el.innerHTML = `
        <div style="font-weight:700">${username}</div>
        <div style="font-size:13px;color:#33ff33">${payload.fakeIp}</div>
        <div class="pm-preview" style="color:#666"></div>
      `;
      el.onclick = () => openPrivateChat(username);
      pmList.insertBefore(el, pmList.firstChild);
    }
    
    const messages = activePrivateChats.get(username);
    messages.push(payload);
    
    // Update preview
    const pmItem = document.querySelector(`.pmItem[data-username="${username}"]`);
    if (pmItem) {
      const preview = pmItem.querySelector('.pm-preview');
      preview.textContent = payload.text.substring(0, 30) + (payload.text.length > 30 ? '...' : '');
      // Move to top
      pmList.insertBefore(pmItem, pmList.firstChild);
    }
    
    updatePrivateChatMessages(username);
  }

  function openPrivateChat(username) {
    // Remove active class from all items
    document.querySelectorAll('.pmItem').forEach(item => item.classList.remove('active'));
    
    // Add active class to clicked item
    const pmItem = document.querySelector(`.pmItem[data-username="${username}"]`);
    if (pmItem) pmItem.classList.add('active');
    
    let chatBox = document.querySelector(`.private-chat-box[data-username="${username}"]`);
    if (!chatBox) {
      // Close other chat boxes on mobile
      if (window.innerWidth <= 768) {
        document.querySelectorAll('.private-chat-box').forEach(box => box.remove());
      }
      
      chatBox = document.createElement('div');
      chatBox.className = 'private-chat-box';
      chatBox.setAttribute('data-username', username);
      
      const boxPosition = calculateChatBoxPosition();
      Object.assign(chatBox.style, boxPosition);
      
      chatBox.innerHTML = `
        <div class="private-chat-header">
          <div style="font-weight:700">${username}</div>
          <div class="chat-controls">
            <button class="btn" onclick="minimizeChat(this)" title="Minimize">_</button>
            <button class="btn" onclick="this.closest('.private-chat-box').remove()">×</button>
          </div>
        </div>
        <div class="private-chat-messages"></div>
        <div class="private-chat-input">
          <textarea class="input" 
            placeholder="Type your message..." 
            onkeyup="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendPrivate('${username}',this)}"
            rows="1"
          ></textarea>
          <button class="btn" onclick="sendPrivate('${username}',this.previousElementSibling)">Send</button>
        </div>
      `;
      document.body.appendChild(chatBox);
      updatePrivateChatMessages(username);
      
      // Focus input
      chatBox.querySelector('textarea').focus();
    }
  }
  
  function calculateChatBoxPosition() {
    const existingBoxes = document.querySelectorAll('.private-chat-box');
    const baseRight = window.innerWidth <= 768 ? 0 : 320; // Account for sidebar on desktop
    const spacing = 20;
    
    if (window.innerWidth <= 768) {
      return {
        bottom: '0',
        right: '0',
        left: '0',
        width: '100%',
        height: '50vh'
      };
    }
    
    const right = baseRight + (existingBoxes.length * (320 + spacing));
    
    return {
      bottom: '0',
      right: right + 'px',
      width: '320px',
      height: '400px'
    };
  }
  
  function minimizeChat(btn) {
    const chatBox = btn.closest('.private-chat-box');
    const messages = chatBox.querySelector('.private-chat-messages');
    const input = chatBox.querySelector('.private-chat-input');
    
    if (messages.style.display === 'none') {
      messages.style.display = 'flex';
      input.style.display = 'flex';
      chatBox.style.height = window.innerWidth <= 768 ? '50vh' : '400px';
      btn.textContent = '_';
    } else {
      messages.style.display = 'none';
      input.style.display = 'none';
      chatBox.style.height = 'auto';
      btn.textContent = '□';
    }
  }

  function updatePrivateChatMessages(username) {
    const messages = activePrivateChats.get(username) || [];
    const chatBox = document.querySelector(`.private-chat-box[data-username="${username}"] .private-chat-messages`);
    if (chatBox) {
      chatBox.innerHTML = messages.map(msg => `
        <div class="msg" style="border-left: 4px solid ${msg.color || '#00ff00'}">
          <div class="meta">${msg.from} · ${msg.fakeIp}</div>
          <div class="msgBody">${msg.text}</div>
        </div>
      `).join('');
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }

  function sendPrivate(username, input) {
    const text = input.value.trim();
    if (!text) return;
    socket.emit('chat message', `#${username} ${text}`);
    input.value = '';
  }

  function changeLanguage() {
    const lang = document.getElementById('language-selector').value;
    const translation = translations[lang] || translations.en;
    
    document.getElementById('global-chat-text').textContent = translation.globalChat;
    document.querySelector('.pmHeader').textContent = translation.privateSidebar;
    msgInput.placeholder = translation.sendPlaceholder;
    sendBtn.textContent = translation.sendBtn;
    
    document.querySelector('.pmList').nextElementSibling.textContent = translation.privateNote;
    
    localStorage.setItem('preferredLanguage', lang);
  }

  // Initialize with system language
  const systemLang = navigator.language.split('-')[0];
  const storedLang = localStorage.getItem('preferredLanguage');
  const defaultLang = translations.hasOwnProperty(systemLang) ? systemLang : 'en';
  const selectedLang = storedLang || defaultLang;
  
  document.getElementById('language-selector').value = selectedLang;
  changeLanguage();

  socket.on('chat message', (p) => appendGlobal(p));
  socket.on('private message', (p) => appendPrivate(p));
  socket.on('system', (t) => { const el=document.createElement('div'); el.className='msg'; el.textContent='* '+t; chatBox.appendChild(el); });
  
  sendBtn.addEventListener('click', send);
  msgInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') send(); });
  
  function send() {
    const t = msgInput.value.trim();
    if (!t) return;
    socket.emit('chat message', t);
    msgInput.value = '';
  }
</script>
</body>
</html>
